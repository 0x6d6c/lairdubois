{% extends 'LadbCoreBundle:Common/Header:_entity-avatar-header.part.html.twig' %}

{# set entity #}
{# set ownerUser (facultative) #}
{# set likeContext (facultative) #}
{# set collectionContext (facultative) #}
{# set watchContext (facultative) #}

{% set authored = entity.user is defined %}
{% set ownerUser = ownerUser is defined ? ownerUser : false %}
{% set isPublic = entity.isPublic is defined ? entity.isPublic : true %}

{% block headerToolsInner %}
    {% block headerToolsButtons %}
        {% if likeContext is defined and not ownerUser %}
            {% include 'LadbCoreBundle:Core/Like:_widget.part.html.twig' with { 'likeContext':likeContext } %}
        {% endif %}
        {% if collectionContext is defined %}
            {% include 'LadbCoreBundle:Collection/Collection:_widget.part.html.twig' with { 'collectionContext':collectionContext } %}
        {% endif %}
        {% if authored and ownerUser %}
            <a href="{{ ladb_entity_url_action(entity, 'edit', false, false) }}" class="btn btn-default"><i class="ladb-icon-edit"></i> {{ 'default.edit'|trans() }}</a>
        {% endif %}
    {% endblock %}
    <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="ladb-icon-more"></i> <span class="caret"></span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right">
            {% block headerToolsItems %}
                {% if is_granted("ROLE_ADMIN") or (ownerUser and not isPublic) %}
                    {% if authored and not ownerUser %}
                        <li><a href="{{ ladb_entity_url_action(entity, 'edit', false, false) }}"><i class="ladb-icon-edit"></i> {{ 'default.edit'|trans() }}</a></li>
                    {% endif %}
                    {% if is_granted("ROLE_ADMIN") or (ownerUser and not isPublic) %}
                        <li class="dropdown-item-danger"><a href="#delete_entity_modal" data-toggle="modal"><i class="ladb-icon-delete"></i> {{ 'default.delete'|trans() }}...</a></li>
                    {% endif %}
                    {% if isPublic %}
                        <li role="separator" class="divider"></li>
                    {% endif %}
                {% endif %}
                {% if isPublic %}
                    <li><a href="#share_modal" data-toggle="modal"><i class="ladb-icon-share"></i> {{ 'default.share'|trans() }}...</a></li>
                    {% if not ownerUser %}
                        <li>{% include 'LadbCoreBundle:Core/Report:_widget-item.part.html.twig' with { 'entityType':entity.type, 'entityId':entity.id } %}</li>
                    {% endif %}
                {% endif %}
                {% if watchContext is defined and watchContext is not null and is_granted("ROLE_USER") %}
                    <li role="separator" class="divider"></li>
                    <li class="dropdown-header"><i class="ladb-icon-notifications"></i> {{ 'notification.nav'|trans }}</li>
                    <li class="text-center">{% include 'LadbCoreBundle:Core/Watch:_widget.part.html.twig' with { 'watchContext':watchContext } %}</li>
                {% endif %}
                {% if is_granted("ROLE_ADMIN") and authored %}
                    {% block adminItems %}
                        <li role="separator" class="divider"></li>
                        <li class="dropdown-header"><i class="ladb-icon-admin"></i> Admin</li>
                        <li><a href="{{ ladb_entity_url_action(entity, entity.isLocked ? 'unlock' : 'lock', true, false) }}"><i class="ladb-icon-{% if entity.isLocked %}unlock{% else %}lock{% endif %} ladb-icon-fixed-center"></i> {{ (entity.isLocked ? 'default.unlock' : 'default.lock')|trans() }}</a></li>
                        {% if isPublic %}
                            <li><a href="#unpublish_entity_modal" data-toggle="modal"><i class="ladb-icon-unpublish"></i> {{ 'default.unpublish'|trans() }}...</a></li>
                        {% endif %}
                    {% endblock %}
                {% endif %}
            {% endblock %}
        </ul>
    </div>
{% endblock %}

{% block headerInner %}
    {{ parent() }}
    {% if isPublic %}
        {% embed 'LadbCoreBundle:Common:Modal/_modal.part.html.twig' with { 'id':'share_modal', 'title':('default.share'|trans()) } %}
            {% use 'LadbCoreBundle:Common:sharebuttons-widget.blocks.html.twig' %}
            {% block bodyInner %}
                <h4>{{ 'share.social.heading'|trans() }}</h4>
                {% set sbTooltipPlacement = 'top' %}
                {{ block('sharebuttonsInlineHorizontal') }}
                {% if false %}
                    <hr>
                    <h4>{{ 'share.sticker.heading'|trans() }}</h4>
                    <p>{{ ('share.sticker.help.'~wonderType)|trans()|raw }}</p>
                    <p>{{ 'share.sticker.help.common'|trans()|raw }}</p>
                    <ul class="nav nav-pills">
                        <li class="active"><a href="#ladb_sticker_bbcode" data-toggle="tab">BBCode</a></li>
                        <li><a href="#ladb_sticker_html" data-toggle="tab">HTML</a></li>
                        <li><a href="#ladb_sticker_markdown" data-toggle="tab">Markdown</a></li>
                        <li><a href="#ladb_sticker_preview" data-toggle="tab">Aperçu</a></li>
                    </ul>
                    <div class="tab-content ladb-margin-top">
                        <div class="tab-pane active" id="ladb_sticker_bbcode">
                            <textarea class="form-control" style="font-family: courier;" rows="5" onclick="$(this).focus(); $(this).select();"></textarea>
                        </div>
                        <div class="tab-pane" id="ladb_sticker_html">
                            <textarea class="form-control" style="font-family: courier;" rows="5" onclick="$(this).focus(); $(this).select();"></textarea>
                        </div>
                        <div class="tab-pane" id="ladb_sticker_markdown">
                            <textarea class="form-control" style="font-family: courier;" rows="5" onclick="$(this).focus(); $(this).select();"></textarea>
                        </div>
                        <div class="tab-pane" id="ladb_sticker_preview" style="height: 300px;">
                            {% include 'LadbCoreBundle:Common:_loading.part.html.twig' with { 'noHidden':true} %}
                            <p class="text-center"><img src="" height="300"></p>
                        </div>
                    </div>
                    <script>
                        $('#share_modal').on('show.bs.modal', function (e) {
                            $("#ladb_sticker_bbcode textarea").val("{{ include('LadbCoreBundle:Wonder:_sticker.bbcode.twig')|escape('js') }}");
                            $("#ladb_sticker_html textarea").val("{{ include('LadbCoreBundle:Wonder:_sticker.html.twig')|escape('js') }}");
                            $("#ladb_sticker_markdown textarea").val("{{ include('LadbCoreBundle:Wonder:_sticker.markdown.twig')|escape('js') }}");
                        });
                        $('a[href="#ladb_sticker_preview"]').on("shown.bs.tab", function (e) {
                            var img = $("#ladb_sticker_preview img");
                            if (img.attr("src") === "") {
                                var src = "{{ ladb_entity_url_action(entity, 'sticker', false, false) }}";
                                img.on("load", function() {
                                    $("#ladb_sticker_preview .ladb-loading").remove();
                                });
                                img.attr("src", src);
                            }
                        });
                    </script>
                {% endif %}
            {% endblock %}
            {% block footerInner %}
                <a href="#" class="btn btn-default" data-dismiss="modal">{{ 'default.close'|trans() }}</a>
            {% endblock %}
        {% endembed %}
    {% endif %}
    {% include 'LadbCoreBundle:Common:_delete-entity-modal.part.html.twig' with { 'id':'delete_entity_modal', 'entityTitle':entity.title, 'deletePath':ladb_entity_url_action(entity, 'delete', false, false) } %}
    {% if is_granted("ROLE_ADMIN") and authored %}
        {% block adminModals %}
            {% if isPublic %}
                {% embed 'LadbCoreBundle:Common:Modal/_modal.part.html.twig' with { 'id':'unpublish_entity_modal', 'title':('default.unpublishing'|trans()) } %}
                    {% block bodyInner %}
                        <p>La dépublication de <strong>{{ entity.title }}</strong> la rendra invisible pour les autres utilisateurs.</p>
                        <p>Confirmez l'action pour continuer.</p>
                    {% endblock %}
                    {% block footerInner %}
                        <a href="#" class="btn btn-default" data-dismiss="modal">{{ 'default.cancel'|trans() }}</a>
                        <a href="{{ ladb_entity_url_action(entity, 'unpublish', false, false) }}" class="btn btn-primary" data-loading-text="{{ 'default.loading'|trans() }}" onclick="$(this).button('loading');"><i class="ladb-icon-unpublish"></i> {{ 'default.unpublish'|trans() }}</a>
                    {% endblock %}
                {% endembed %}
            {% endif %}
        {% endblock %}
    {% endif %}
{% endblock %}
